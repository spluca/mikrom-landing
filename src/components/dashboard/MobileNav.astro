---
/**
 * MobileNav - Mobile navigation drawer component
 *
 * @description
 * Implements a slide-in navigation drawer for mobile devices.
 * Opens from the left with a backdrop overlay. Automatically closes
 * on navigation or when clicking the backdrop/close button.
 *
 * Features:
 * - Slide-in drawer from left
 * - Backdrop overlay
 * - Close button
 * - Auto-close on navigation
 * - Smooth transitions
 * - Same navigation structure as desktop sidebar
 *
 * @example
 * ```astro
 * <MobileNav />
 * ```
 */

import { Icon } from 'astro-icon/components';
import { dashboardNavigation } from '../../config/dashboard-navigation';

// Get current path for active state
const currentPath = Astro.url.pathname;

/**
 * Check if a navigation item or its children are active
 */
function isActive(href: string, children?: any[]): boolean {
  if (currentPath === href) return true;
  if (children) {
    return children.some((child) => currentPath === child.href);
  }
  return false;
}
---

<!-- Backdrop Overlay -->
<div id="mobile-nav-backdrop" class="mobile-nav-backdrop" aria-hidden="true"></div>

<!-- Mobile Navigation Drawer -->
<aside
  id="mobile-nav"
  class="mobile-nav"
  aria-label="Mobile navigation"
  role="dialog"
  aria-modal="true"
>
  <div class="mobile-nav-inner">
    <!-- Header with Close Button -->
    <div class="mobile-nav-header">
      <a href="/dashboard" class="mobile-nav-logo">
        <Icon name="lucide:layout-dashboard" class="mobile-nav-logo-icon" />
        <span class="mobile-nav-logo-text">Dashboard</span>
      </a>
      <button id="mobile-nav-close" class="mobile-nav-close-btn" aria-label="Close navigation">
        <Icon name="lucide:x" class="close-icon" />
      </button>
    </div>

    <!-- Navigation -->
    <nav class="mobile-nav-content" aria-label="Main navigation">
      {
        dashboardNavigation.map((section) => (
          <div class="nav-section">
            {/* Section Header */}
            {section.title && (
              <div class="nav-section-header">
                <span class="nav-section-title">{section.title}</span>
              </div>
            )}

            {/* Navigation Items */}
            <ul class="nav-items" role="list">
              {section.items.map((item) => {
                const itemActive = isActive(item.href, item.children);

                return (
                  <li>
                    {/* Parent Item */}
                    <a
                      href={item.href}
                      class:list={['nav-item', { 'nav-item-active': itemActive }]}
                      aria-current={currentPath === item.href ? 'page' : undefined}
                      data-mobile-nav-link
                    >
                      <Icon name={`lucide:${item.icon}`} class="nav-item-icon" />
                      <span class="nav-item-label">{item.label}</span>
                      {item.children && (
                        <Icon
                          name="lucide:chevron-down"
                          class:list={['nav-item-chevron', { 'nav-item-chevron-open': itemActive }]}
                        />
                      )}
                    </a>

                    {/* Nested Children */}
                    {item.children && (
                      <ul
                        class:list={['nav-children', { 'nav-children-open': itemActive }]}
                        role="list"
                      >
                        {item.children.map((child) => (
                          <li>
                            <a
                              href={child.href}
                              class:list={[
                                'nav-child-item',
                                { 'nav-child-item-active': currentPath === child.href },
                              ]}
                              aria-current={currentPath === child.href ? 'page' : undefined}
                              data-mobile-nav-link
                            >
                              <Icon name={`lucide:${child.icon}`} class="nav-child-icon" />
                              <span class="nav-child-label">{child.label}</span>
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </li>
                );
              })}
            </ul>
          </div>
        ))
      }
    </nav>
  </div>
</aside>

<style>
  /* Backdrop Overlay */
  .mobile-nav-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 40;
    opacity: 0;
    pointer-events: none;
    transition: opacity 300ms ease;
  }

  .mobile-nav-backdrop.mobile-nav-open {
    opacity: 1;
    pointer-events: auto;
  }

  /* Mobile Navigation Drawer */
  .mobile-nav {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 280px;
    max-width: 85vw;
    background: var(--color-surface, #fff);
    border-right: 1px solid var(--color-border, #e5e7eb);
    z-index: 50;
    transform: translateX(-100%);
    transition: transform 300ms ease;
    display: block; /* Always rendered, controlled by transform */
  }

  .mobile-nav.mobile-nav-open {
    transform: translateX(0);
  }

  /* Hide on desktop */
  @media (min-width: 768px) {
    .mobile-nav,
    .mobile-nav-backdrop {
      display: none;
    }
  }

  .mobile-nav-inner {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  /* Header */
  .mobile-nav-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid var(--color-border, #e5e7eb);
  }

  .mobile-nav-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: var(--color-text, #000);
    font-weight: 600;
    font-size: 1.125rem;
  }

  .mobile-nav-logo-icon {
    width: 1.5rem;
    height: 1.5rem;
    flex-shrink: 0;
    color: var(--color-primary, #6366f1);
  }

  .mobile-nav-logo-text {
    white-space: nowrap;
  }

  .mobile-nav-close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
    color: var(--color-text-muted, #6b7280);
    cursor: pointer;
    transition:
      background-color 150ms ease,
      color 150ms ease;
  }

  .mobile-nav-close-btn:hover {
    background: var(--color-background, #f9fafb);
    color: var(--color-text, #000);
  }

  .close-icon {
    width: 1.5rem;
    height: 1.5rem;
  }

  /* Navigation Content */
  .mobile-nav-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem 0;
  }

  /* Custom scrollbar */
  .mobile-nav-content::-webkit-scrollbar {
    width: 6px;
  }

  .mobile-nav-content::-webkit-scrollbar-track {
    background: transparent;
  }

  .mobile-nav-content::-webkit-scrollbar-thumb {
    background: var(--color-border, #e5e7eb);
    border-radius: 3px;
  }

  .mobile-nav-content::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted, #6b7280);
  }

  /* Section */
  .nav-section {
    margin-bottom: 1.5rem;
  }

  .nav-section:last-child {
    margin-bottom: 0;
  }

  .nav-section-header {
    padding: 0 1rem;
    margin-bottom: 0.5rem;
  }

  .nav-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted, #6b7280);
  }

  /* Navigation Items */
  .nav-items {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    margin: 0 0.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: var(--color-text, #000);
    font-size: 0.875rem;
    font-weight: 500;
    transition:
      background-color 150ms ease,
      color 150ms ease;
    /* Larger touch targets for mobile */
    min-height: 44px;
  }

  .nav-item:hover {
    background: var(--color-background, #f9fafb);
    color: var(--color-primary, #6366f1);
  }

  .nav-item-active {
    background: var(--color-primary, #6366f1);
    color: white;
  }

  .nav-item-active:hover {
    background: var(--color-primary, #6366f1);
    color: white;
  }

  .nav-item-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .nav-item-label {
    flex: 1;
  }

  .nav-item-chevron {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    transition: transform 200ms ease;
  }

  .nav-item-chevron-open {
    transform: rotate(180deg);
  }

  /* Nested Children */
  .nav-children {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 200ms ease;
  }

  .nav-children-open {
    max-height: 500px;
  }

  .nav-child-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 1rem 0.625rem 3rem;
    margin: 0 0.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: var(--color-text-muted, #6b7280);
    font-size: 0.875rem;
    transition:
      background-color 150ms ease,
      color 150ms ease;
    /* Larger touch targets for mobile */
    min-height: 44px;
  }

  .nav-child-item:hover {
    background: var(--color-background, #f9fafb);
    color: var(--color-text, #000);
  }

  .nav-child-item-active {
    background: var(--color-background, #f9fafb);
    color: var(--color-primary, #6366f1);
    font-weight: 500;
  }

  .nav-child-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .nav-child-label {
    flex: 1;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .mobile-nav,
    .mobile-nav-backdrop,
    .nav-item,
    .nav-item-chevron,
    .nav-children,
    .nav-child-item,
    .mobile-nav-close-btn {
      transition: none;
    }
  }

  /* Focus visible styles for keyboard navigation */
  .nav-item:focus-visible,
  .nav-child-item:focus-visible,
  .mobile-nav-close-btn:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .mobile-nav {
      background: var(--color-surface, #1f2937);
      border-right-color: var(--color-border, #374151);
    }

    .mobile-nav-header {
      border-bottom-color: var(--color-border, #374151);
    }

    .nav-item:hover {
      background: var(--color-background, #111827);
    }

    .nav-child-item:hover {
      background: var(--color-background, #111827);
    }

    .mobile-nav-close-btn:hover {
      background: var(--color-background, #111827);
    }
  }
</style>

<script>
  /**
   * Mobile Navigation Client-Side Functionality
   *
   * Manages:
   * - Open/close drawer
   * - Backdrop click to close
   * - Auto-close on navigation
   * - Custom events for state changes
   * - Body scroll lock when open
   */

  function initMobileNav() {
    const mobileNav = document.getElementById('mobile-nav');
    const backdrop = document.getElementById('mobile-nav-backdrop');
    const closeBtn = document.getElementById('mobile-nav-close');

    if (!mobileNav || !backdrop || !closeBtn) return;

    // Open mobile nav
    function openMobileNav() {
      if (!mobileNav || !backdrop || !closeBtn) return;

      mobileNav.classList.add('mobile-nav-open');
      backdrop.classList.add('mobile-nav-open');
      document.body.style.overflow = 'hidden';

      // Dispatch custom event
      const event = new CustomEvent('mobile-nav-toggle', {
        detail: { open: true },
      });
      document.dispatchEvent(event);

      // Focus close button for accessibility
      closeBtn.focus();
    }

    // Close mobile nav
    function closeMobileNav() {
      if (!mobileNav || !backdrop) return;

      mobileNav.classList.remove('mobile-nav-open');
      backdrop.classList.remove('mobile-nav-open');
      document.body.style.overflow = '';

      // Dispatch custom event
      const event = new CustomEvent('mobile-nav-toggle', {
        detail: { open: false },
      });
      document.dispatchEvent(event);
    }

    // Listen for open events from hamburger button (in TopNav)
    document.addEventListener('open-mobile-nav', openMobileNav);

    // Close button click
    closeBtn.addEventListener('click', closeMobileNav);

    // Backdrop click to close
    backdrop.addEventListener('click', closeMobileNav);

    // Auto-close on navigation link click
    const navLinks = mobileNav.querySelectorAll('[data-mobile-nav-link]');
    navLinks.forEach((link) => {
      link.addEventListener('click', () => {
        // Small delay to allow navigation to start
        setTimeout(closeMobileNav, 100);
      });
    });

    // Close on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileNav.classList.contains('mobile-nav-open')) {
        closeMobileNav();
      }
    });

    // Handle route changes (for Astro View Transitions)
    document.addEventListener('astro:before-preparation', closeMobileNav);
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMobileNav);
  } else {
    initMobileNav();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initMobileNav);
</script>
