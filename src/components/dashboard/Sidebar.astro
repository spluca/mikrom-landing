---
/**
 * Sidebar - Desktop sidebar navigation component
 *
 * @description
 * Implements the desktop sidebar with collapsible functionality,
 * nested navigation support, active page highlighting, and hover expansion.
 * State is persisted in localStorage.
 *
 * Features:
 * - Collapsible with icon-only mode
 * - Hover expansion when collapsed
 * - Active page highlighting
 * - Nested navigation (2 levels)
 * - Section headers
 * - Lucide icons
 *
 * @example
 * ```astro
 * <Sidebar />
 * ```
 */

import { Icon } from 'astro-icon/components';
import { dashboardNavigation } from '../../config/dashboard-navigation';

// Get current path for active state
const currentPath = Astro.url.pathname;

/**
 * Check if a navigation item or its children are active
 */
function isActive(href: string, children?: any[]): boolean {
  if (currentPath === href) return true;
  if (children) {
    return children.some((child) => currentPath === child.href);
  }
  return false;
}
---

<aside id="dashboard-sidebar" class="sidebar" aria-label="Dashboard navigation">
  <div class="sidebar-inner">
    <!-- Logo/Brand Area -->
    <div class="sidebar-header">
      <a href="/dashboard" class="sidebar-logo">
        <Icon name="lucide:layout-dashboard" class="sidebar-logo-icon" />
        <span class="sidebar-logo-text">Dashboard</span>
      </a>
    </div>

    <!-- Navigation -->
    <nav class="sidebar-nav" aria-label="Main navigation">
      {
        dashboardNavigation.map((section) => (
          <div class="nav-section">
            {/* Section Header */}
            {section.title && (
              <div class="nav-section-header">
                <span class="nav-section-title">{section.title}</span>
              </div>
            )}

            {/* Navigation Items */}
            <ul class="nav-items" role="list">
              {section.items.map((item) => {
                const itemActive = isActive(item.href, item.children);

                return (
                  <li>
                    {/* Parent Item */}
                    <a
                      href={item.href}
                      class:list={['nav-item', { 'nav-item-active': itemActive }]}
                      aria-current={currentPath === item.href ? 'page' : undefined}
                    >
                      <Icon name={`lucide:${item.icon}`} class="nav-item-icon" />
                      <span class="nav-item-label">{item.label}</span>
                      {item.children && (
                        <Icon
                          name="lucide:chevron-down"
                          class:list={['nav-item-chevron', { 'nav-item-chevron-open': itemActive }]}
                        />
                      )}
                    </a>

                    {/* Nested Children */}
                    {item.children && (
                      <ul
                        class:list={['nav-children', { 'nav-children-open': itemActive }]}
                        role="list"
                      >
                        {item.children.map((child) => (
                          <li>
                            <a
                              href={child.href}
                              class:list={[
                                'nav-child-item',
                                { 'nav-child-item-active': currentPath === child.href },
                              ]}
                              aria-current={currentPath === child.href ? 'page' : undefined}
                            >
                              <Icon name={`lucide:${child.icon}`} class="nav-child-icon" />
                              <span class="nav-child-label">{child.label}</span>
                            </a>
                          </li>
                        ))}
                      </ul>
                    )}
                  </li>
                );
              })}
            </ul>
          </div>
        ))
      }
    </nav>

    <!-- Collapse Toggle Button -->
    <div class="sidebar-footer">
      <button
        id="sidebar-toggle"
        class="sidebar-toggle-btn"
        aria-label="Toggle sidebar"
        aria-expanded="true"
      >
        <Icon name="lucide:chevrons-left" class="toggle-icon toggle-icon-collapse" />
        <Icon name="lucide:chevrons-right" class="toggle-icon toggle-icon-expand" />
        <span class="sidebar-toggle-text">Collapse</span>
      </button>
    </div>
  </div>
</aside>

<style>
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: var(--sidebar-width, 256px);
    background: var(--color-surface, #fff);
    border-right: 1px solid var(--color-border, #e5e7eb);
    z-index: 30;
    transition: width 200ms ease;
    display: none; /* Hidden on mobile by default */
  }

  /* Show sidebar on desktop */
  @media (min-width: 768px) {
    .sidebar {
      display: block;
    }
  }

  .sidebar-inner {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  /* Logo/Header */
  .sidebar-header {
    height: 64px;
    padding: 0 1rem;
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    display: flex;
    align-items: center;
  }

  .sidebar-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: var(--color-text, #000);
    font-weight: 600;
    font-size: 1.125rem;
  }

  .sidebar-logo-icon {
    width: 1.5rem;
    height: 1.5rem;
    flex-shrink: 0;
    color: var(--color-primary, #6366f1);
  }

  .sidebar-logo-text {
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 200ms ease;
  }

  /* Navigation */
  .sidebar-nav {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem 0;
  }

  /* Custom scrollbar */
  .sidebar-nav::-webkit-scrollbar {
    width: 6px;
  }

  .sidebar-nav::-webkit-scrollbar-track {
    background: transparent;
  }

  .sidebar-nav::-webkit-scrollbar-thumb {
    background: var(--color-border, #e5e7eb);
    border-radius: 3px;
  }

  .sidebar-nav::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted, #6b7280);
  }

  /* Section */
  .nav-section {
    margin-bottom: 1.5rem;
  }

  .nav-section:last-child {
    margin-bottom: 0;
  }

  .nav-section-header {
    padding: 0 1rem;
    margin-bottom: 0.5rem;
  }

  .nav-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted, #6b7280);
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 200ms ease;
  }

  /* Navigation Items */
  .nav-items {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-items > li {
    margin-bottom: 0.25rem;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 1rem;
    margin: 0 0.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: var(--color-text, #000);
    font-size: 0.875rem;
    font-weight: 500;
    transition:
      background-color 150ms ease,
      color 150ms ease;
    position: relative;
  }

  .nav-item:hover {
    background: var(--color-background, #f9fafb);
    color: var(--color-primary, #6366f1);
  }

  .nav-item-active {
    background: var(--color-primary, #6366f1);
    color: white;
  }

  .nav-item-active:hover {
    background: color-mix(in srgb, var(--color-primary, #6366f1) 85%, black) !important;
    color: white !important;
  }

  .nav-item-active .nav-item-icon {
    color: white;
  }

  .nav-item-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .nav-item-label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 200ms ease;
  }

  .nav-item-chevron {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    transition:
      transform 200ms ease,
      opacity 200ms ease;
  }

  .nav-item-chevron-open {
    transform: rotate(180deg);
  }

  /* Nested Children */
  .nav-children {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 0;
    overflow: hidden;
    transition: max-height 200ms ease;
  }

  .nav-children-open {
    max-height: 500px; /* Large enough for content */
  }

  .nav-children > li {
    margin-bottom: 0.25rem;
  }

  .nav-child-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem 0.5rem 3rem;
    margin: 0 0.5rem;
    border-radius: 0.5rem;
    text-decoration: none;
    color: var(--color-text-muted, #6b7280);
    font-size: 0.875rem;
    transition:
      background-color 150ms ease,
      color 150ms ease;
  }

  .nav-child-item:hover {
    background: var(--color-background, #f9fafb);
    color: var(--color-text, #000);
  }

  .nav-child-item-active {
    background: var(--color-background, #f9fafb);
    color: var(--color-primary, #6366f1);
    font-weight: 500;
  }

  .nav-child-icon {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
  }

  .nav-child-label {
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 200ms ease;
  }

  /* Footer / Toggle Button */
  .sidebar-footer {
    padding: 1rem;
    border-top: 1px solid var(--color-border, #e5e7eb);
  }

  .sidebar-toggle-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.625rem 1rem;
    border: none;
    border-radius: 0.5rem;
    background: transparent;
    color: var(--color-text-muted, #6b7280);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition:
      background-color 150ms ease,
      color 150ms ease;
  }

  .sidebar-toggle-btn:hover {
    background: var(--color-background, #f9fafb);
    color: var(--color-text, #000);
  }

  .toggle-icon {
    width: 1.25rem;
    height: 1.25rem;
    flex-shrink: 0;
  }

  .toggle-icon-expand {
    display: none;
  }

  .sidebar-toggle-text {
    flex: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    transition: opacity 200ms ease;
  }

  /* Collapsed State */
  :global(.sidebar-collapsed) .sidebar {
    width: var(--sidebar-collapsed-width, 64px);
  }

  :global(.sidebar-collapsed) .sidebar-logo-text,
  :global(.sidebar-collapsed) .nav-section-title,
  :global(.sidebar-collapsed) .nav-item-label,
  :global(.sidebar-collapsed) .nav-item-chevron,
  :global(.sidebar-collapsed) .nav-child-label,
  :global(.sidebar-collapsed) .sidebar-toggle-text {
    opacity: 0;
    pointer-events: none;
  }

  :global(.sidebar-collapsed) .nav-children {
    max-height: 0 !important;
  }

  :global(.sidebar-collapsed) .toggle-icon-collapse {
    display: none;
  }

  :global(.sidebar-collapsed) .toggle-icon-expand {
    display: block;
  }

  :global(.sidebar-collapsed) .sidebar-toggle-btn[aria-expanded='false'] {
    justify-content: center;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .sidebar,
    .sidebar-logo-text,
    .nav-section-title,
    .nav-item,
    .nav-item-label,
    .nav-item-chevron,
    .nav-children,
    .nav-child-item,
    .nav-child-label,
    .sidebar-toggle-btn,
    .sidebar-toggle-text {
      transition: none;
    }
  }

  /* Focus visible styles for keyboard navigation */
  .nav-item:focus-visible,
  .nav-child-item:focus-visible,
  .sidebar-toggle-btn:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .sidebar {
      background: var(--color-surface, #1f2937);
      border-right-color: var(--color-border, #374151);
    }

    .sidebar-header {
      border-bottom-color: var(--color-border, #374151);
    }

    .sidebar-footer {
      border-top-color: var(--color-border, #374151);
    }

    .nav-item:hover {
      background: var(--color-background, #111827);
    }

    .nav-child-item:hover {
      background: var(--color-background, #111827);
    }

    .sidebar-toggle-btn:hover {
      background: var(--color-background, #111827);
    }
  }
</style>

<script>
  /**
   * Sidebar Client-Side Functionality
   *
   * Manages:
   * - Collapse/expand toggle
   * - localStorage persistence
   * - Custom events for state changes
   */

  function initSidebar() {
    const sidebar = document.getElementById('dashboard-sidebar');
    const toggleBtn = document.getElementById('sidebar-toggle');

    if (!sidebar || !toggleBtn) return;

    // Load collapse state from localStorage
    const isCollapsed = localStorage.getItem('dashboard-sidebar-collapsed') === 'true';

    if (isCollapsed) {
      document.documentElement.classList.add('sidebar-collapsed');
      toggleBtn.setAttribute('aria-expanded', 'false');
    }

    // Toggle button click handler
    toggleBtn.addEventListener('click', () => {
      const currentlyCollapsed = document.documentElement.classList.contains('sidebar-collapsed');
      const newCollapsed = !currentlyCollapsed;

      if (newCollapsed) {
        document.documentElement.classList.add('sidebar-collapsed');
        toggleBtn.setAttribute('aria-expanded', 'false');
      } else {
        document.documentElement.classList.remove('sidebar-collapsed');
        toggleBtn.setAttribute('aria-expanded', 'true');
      }

      // Save to localStorage
      localStorage.setItem('dashboard-sidebar-collapsed', String(newCollapsed));

      // Dispatch custom event for other components
      const event = new CustomEvent('sidebar-toggle', {
        detail: { collapsed: newCollapsed },
      });
      document.dispatchEvent(event);
    });
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSidebar);
  } else {
    initSidebar();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initSidebar);
</script>
