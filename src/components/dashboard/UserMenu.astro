---
/**
 * UserMenu - User dropdown menu component
 *
 * @description
 * Dropdown menu displaying user information and account options.
 * Features user avatar with fallback initials, user name and email,
 * and dropdown menu with Profile, Settings, and Logout links.
 *
 * Features:
 * - User avatar with fallback to initials
 * - User name and email display
 * - Dropdown menu with account options
 * - Click outside to close
 * - Keyboard navigation support (Arrow keys, Enter, Escape)
 * - Accessible with proper ARIA attributes
 *
 * @example
 * ```astro
 * <UserMenu />
 * ```
 *
 * @example With custom user data
 * ```astro
 * <UserMenu user={{ name: "Jane Doe", email: "jane@example.com", avatar: "/avatar.jpg" }} />
 * ```
 */

import { Icon } from 'astro-icon/components';

interface Props {
  /** User information to display */
  user?: {
    name: string;
    email: string;
    avatar?: string;
  };
}

// Default placeholder user data for demonstration
const defaultUser = {
  name: 'Alex Johnson',
  email: 'alex@virex.com',
  avatar: undefined,
};

const { user = defaultUser } = Astro.props;

// Generate initials from name
function getInitials(name: string): string {
  return name
    .split(' ')
    .map((part) => part[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
}

const initials = getInitials(user.name);

// Menu items configuration
const menuItems = [
  {
    label: 'Profile',
    href: '/dashboard/settings/profile',
    icon: 'lucide:user',
  },
  {
    label: 'Settings',
    href: '/dashboard/settings',
    icon: 'lucide:settings',
  },
  {
    label: 'Logout',
    href: '/',
    icon: 'lucide:log-out',
  },
];
---

<div class="user-menu-container">
  <!-- User Menu Button -->
  <button
    type="button"
    id="user-menu-button"
    aria-label="User menu"
    aria-haspopup="true"
    aria-expanded="false"
    class="user-menu-button"
  >
    <!-- User Avatar or Initials -->
    <div class="user-avatar">
      {
        user.avatar ? (
          <img src={user.avatar} alt={user.name} class="avatar-image" />
        ) : (
          <span class="avatar-initials">{initials}</span>
        )
      }
    </div>

    <!-- Chevron Icon -->
    <Icon name="lucide:chevron-down" class="chevron-icon w-4 h-4 text-text-muted" />
  </button>

  <!-- Dropdown Menu -->
  <div
    id="user-menu-dropdown"
    role="menu"
    aria-labelledby="user-menu-button"
    class="user-menu-dropdown hidden"
  >
    <!-- User Info Section -->
    <div class="user-info">
      <div class="user-name">{user.name}</div>
      <div class="user-email">{user.email}</div>
    </div>

    <!-- Divider -->
    <div class="menu-divider"></div>

    <!-- Menu Items -->
    <div class="menu-items">
      {
        menuItems.map((item) => (
          <a href={item.href} role="menuitem" tabindex="-1" data-menu-item class="menu-item">
            <Icon name={item.icon} class="menu-item-icon w-4 h-4" />
            <span>{item.label}</span>
          </a>
        ))
      }
    </div>
  </div>
</div>

<style>
  .user-menu-container {
    position: relative;
  }

  /* User Menu Button */
  .user-menu-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background-color 150ms ease;
  }

  .user-menu-button:hover {
    background: var(--color-background);
  }

  .user-menu-button:focus {
    outline: none;
  }

  .user-menu-button:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* User Avatar */
  .user-avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 9999px;
    overflow: hidden;
    background: var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .avatar-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-initials {
    color: white;
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* Chevron Icon */
  .chevron-icon {
    transition: transform 150ms ease;
  }

  .user-menu-button[aria-expanded='true'] .chevron-icon {
    transform: rotate(180deg);
  }

  /* Dropdown Menu */
  .user-menu-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 240px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow:
      0 10px 15px -3px rgb(0 0 0 / 0.1),
      0 4px 6px -4px rgb(0 0 0 / 0.1);
    z-index: 50;
    opacity: 0;
    transform: translateY(-0.5rem);
    transition:
      opacity 150ms ease,
      transform 150ms ease;
    pointer-events: none;
  }

  .user-menu-dropdown:not(.hidden) {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* User Info Section */
  .user-info {
    padding: 0.75rem 1rem;
  }

  .user-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .user-email {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.125rem;
  }

  /* Menu Divider */
  .menu-divider {
    height: 1px;
    background: var(--color-border);
    margin: 0.25rem 0;
  }

  /* Menu Items */
  .menu-items {
    padding: 0.25rem;
  }

  .menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    color: var(--color-text);
    text-decoration: none;
    cursor: pointer;
    transition: background-color 150ms ease;
  }

  .menu-item:hover,
  .menu-item:focus {
    background: var(--color-background);
    outline: none;
  }

  .menu-item-icon {
    color: var(--color-text-muted);
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .user-menu-button,
    .chevron-icon,
    .user-menu-dropdown,
    .menu-item {
      transition: none;
    }
  }
</style>

<script>
  /**
   * UserMenu Client-Side Functionality
   *
   * Manages:
   * - Dropdown open/close on button click
   * - Click outside to close
   * - Keyboard navigation (Arrow keys, Enter, Escape)
   * - Focus management
   */

  function initUserMenu() {
    const button = document.getElementById('user-menu-button');
    const dropdown = document.getElementById('user-menu-dropdown');

    if (!button || !dropdown) return;

    const menuItems = dropdown.querySelectorAll('[data-menu-item]');
    let currentFocusIndex = -1;

    /**
     * Open the dropdown menu
     */
    function openMenu() {
      button?.setAttribute('aria-expanded', 'true');
      dropdown?.classList.remove('hidden');
      currentFocusIndex = -1;

      // Focus first menu item
      setTimeout(() => {
        focusMenuItem(0);
      }, 50);
    }

    /**
     * Close the dropdown menu
     */
    function closeMenu() {
      button?.setAttribute('aria-expanded', 'false');
      dropdown?.classList.add('hidden');
      currentFocusIndex = -1;
    }

    /**
     * Toggle the dropdown menu
     */
    function toggleMenu() {
      const isExpanded = button?.getAttribute('aria-expanded') === 'true';
      if (isExpanded) {
        closeMenu();
      } else {
        openMenu();
      }
    }

    /**
     * Focus a menu item by index
     */
    function focusMenuItem(index: number) {
      if (index < 0 || index >= menuItems.length) return;

      currentFocusIndex = index;
      (menuItems[index] as HTMLElement).focus();
    }

    /**
     * Handle keyboard navigation
     */
    function handleKeyDown(event: KeyboardEvent) {
      const isExpanded = button?.getAttribute('aria-expanded') === 'true';

      // If menu is closed and user presses Enter or Space on button
      if (!isExpanded && (event.key === 'Enter' || event.key === ' ')) {
        event.preventDefault();
        openMenu();
        return;
      }

      // If menu is open
      if (isExpanded) {
        switch (event.key) {
          case 'Escape':
            event.preventDefault();
            closeMenu();
            button?.focus();
            break;

          case 'ArrowDown':
            event.preventDefault();
            focusMenuItem((currentFocusIndex + 1) % menuItems.length);
            break;

          case 'ArrowUp':
            event.preventDefault();
            focusMenuItem(currentFocusIndex <= 0 ? menuItems.length - 1 : currentFocusIndex - 1);
            break;

          case 'Home':
            event.preventDefault();
            focusMenuItem(0);
            break;

          case 'End':
            event.preventDefault();
            focusMenuItem(menuItems.length - 1);
            break;

          case 'Tab':
            // Close menu on Tab
            closeMenu();
            break;
        }
      }
    }

    /**
     * Handle click outside to close
     */
    function handleClickOutside(event: MouseEvent) {
      const isExpanded = button?.getAttribute('aria-expanded') === 'true';

      if (
        isExpanded &&
        !button?.contains(event.target as Node) &&
        !dropdown?.contains(event.target as Node)
      ) {
        closeMenu();
      }
    }

    // Event Listeners
    button.addEventListener('click', toggleMenu);
    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('click', handleClickOutside);

    // Cleanup function for page transitions
    return () => {
      button.removeEventListener('click', toggleMenu);
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('click', handleClickOutside);
    };
  }

  // Initialize on page load
  let cleanup: (() => void) | undefined;

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      cleanup = initUserMenu();
    });
  } else {
    cleanup = initUserMenu();
  }

  // Re-initialize on Astro page transitions (if using View Transitions)
  document.addEventListener('astro:page-load', () => {
    // Cleanup previous instance
    if (cleanup) {
      cleanup();
    }
    cleanup = initUserMenu();
  });

  // Cleanup on page unload
  document.addEventListener('astro:before-preparation', () => {
    if (cleanup) {
      cleanup();
    }
  });
</script>
