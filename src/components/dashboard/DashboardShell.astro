---
/**
 * DashboardShell - Container component providing dashboard structure
 *
 * @description
 * Provides the main dashboard shell structure with sidebar navigation,
 * top navigation bar, and content area. Manages responsive behavior
 * with mobile navigation drawer and desktop sidebar.
 *
 * Breakpoints:
 * - Mobile: < 768px (sidebar hidden, mobile nav drawer)
 * - Desktop: >= 768px (persistent sidebar)
 *
 * @example
 * ```astro
 * <DashboardShell breadcrumbs={[{ label: 'Dashboard' }]}>
 *   <h1>Page Content</h1>
 * </DashboardShell>
 * ```
 */

import Sidebar from './Sidebar.astro';
import MobileNav from './MobileNav.astro';
import TopNav from './TopNav.astro';
import Breadcrumbs from './Breadcrumbs.astro';

interface Props {
  /** Breadcrumb navigation items */
  breadcrumbs?: Array<{ label: string; href?: string }>;
}

const { breadcrumbs } = Astro.props;
---

<div class="dashboard-shell min-h-screen bg-background">
  <!-- Desktop Sidebar - Hidden on mobile (< 768px) -->
  <Sidebar />

  <!-- Mobile Navigation Drawer - Hidden on desktop (>= 768px) -->
  <MobileNav />

  <!-- Main Content Area -->
  <div class="dashboard-content">
    <!-- Top Navigation Bar -->
    <TopNav />

    <!-- Page Content with Breadcrumbs -->
    <main id="main-content" class="dashboard-main">
      <div class="dashboard-container">
        <!-- Breadcrumbs Navigation -->
        {
          breadcrumbs && breadcrumbs.length > 0 && (
            <div class="mb-6">
              <Breadcrumbs items={breadcrumbs} />
            </div>
          )
        }

        <!-- Page Content Slot -->
        <slot />
      </div>
    </main>
  </div>
</div>

<style>
  .dashboard-shell {
    display: flex;
    position: relative;
  }

  .dashboard-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0; /* Prevent flex item from overflowing */

    /* On mobile, take full width */
    width: 100%;

    /* On desktop, account for sidebar width */
    /* Sidebar component will handle its own width and positioning */
  }

  .dashboard-main {
    flex: 1;
    padding: 1.5rem;
  }

  .dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
  }

  /* Responsive adjustments */
  @media (min-width: 768px) {
    .dashboard-main {
      padding: 2rem;
    }
  }

  @media (min-width: 1024px) {
    .dashboard-main {
      padding: 2.5rem;
    }
  }

  /* Ensure proper spacing when sidebar is present */
  @media (min-width: 768px) {
    .dashboard-content {
      /* Sidebar will use position: fixed, so content needs left margin */
      margin-left: var(--sidebar-width, 256px);
      width: calc(100% - var(--sidebar-width, 256px));
    }

    /* When sidebar is collapsed */
    :global(.sidebar-collapsed) .dashboard-content {
      margin-left: var(--sidebar-collapsed-width, 64px);
      width: calc(100% - var(--sidebar-collapsed-width, 64px));
    }
  }

  /* Smooth transition for sidebar collapse */
  .dashboard-content {
    transition:
      margin-left 200ms ease,
      width 200ms ease;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .dashboard-content {
      transition: none;
    }
  }
</style>

<script>
  /**
   * Dashboard Shell Client-Side Functionality
   *
   * Manages:
   * - Mobile navigation toggle
   * - Sidebar collapse state synchronization
   * - Responsive behavior
   */

  // Initialize dashboard shell
  function initDashboardShell() {
    // Check if sidebar is collapsed from localStorage
    const isCollapsed = localStorage.getItem('dashboard-sidebar-collapsed') === 'true';

    if (isCollapsed) {
      document.documentElement.classList.add('sidebar-collapsed');
    }

    // Listen for sidebar collapse events
    document.addEventListener('sidebar-toggle', ((e: CustomEvent<{ collapsed: boolean }>) => {
      const collapsed = e.detail.collapsed;

      if (collapsed) {
        document.documentElement.classList.add('sidebar-collapsed');
      } else {
        document.documentElement.classList.remove('sidebar-collapsed');
      }
    }) as (e: Event) => void);

    // Listen for mobile nav toggle events
    document.addEventListener('mobile-nav-toggle', ((e: CustomEvent<{ open: boolean }>) => {
      const open = e.detail.open;

      if (open) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }) as (e: Event) => void);
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDashboardShell);
  } else {
    initDashboardShell();
  }

  // Re-initialize on Astro page transitions (if using View Transitions)
  document.addEventListener('astro:page-load', initDashboardShell);
</script>
