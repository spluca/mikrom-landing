---
/**
 * DemoRequestForm - Demo request form with validation
 *
 * @description
 * A form for requesting product demos with company info, team size,
 * and optional message. Supports Netlify Forms, Formspree, and custom endpoints.
 * Runs in demo mode (simulates success) when no action URL is provided.
 *
 * @example Demo mode (no backend)
 * ```astro
 * <DemoRequestForm />
 * ```
 *
 * @example Netlify Forms
 * ```astro
 * <DemoRequestForm netlify formName="demo-request" />
 * ```
 *
 * @example Custom endpoint
 * ```astro
 * <DemoRequestForm action="https://api.example.com/demo" method="POST" />
 * ```
 */

interface Props {
  /** Form action URL - leave empty for client-side only demo */
  action?: string;
  /** HTTP method for form submission */
  method?: 'POST' | 'GET';
  /** Enable Netlify Forms integration */
  netlify?: boolean;
  /** Form name for Netlify Forms */
  formName?: string;
}

const { action = '', method = 'POST', netlify = false, formName = 'demo-request' } = Astro.props;
---

<form
  id="demo-request-form"
  action={action}
  method={method}
  class="space-y-5"
  data-netlify={netlify ? 'true' : undefined}
  name={netlify ? formName : undefined}
  novalidate
>
  <!-- Honeypot field for spam protection -->
  <div class="hidden" aria-hidden="true">
    <label>
      Don't fill this out if you're human:
      <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" />
    </label>
  </div>

  <!-- Netlify hidden field -->
  {netlify && <input type="hidden" name="form-name" value={formName} />}

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
    <div>
      <label for="demo-firstName" class="block text-sm font-medium text-text mb-2">
        First Name <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="demo-firstName"
        name="firstName"
        required
        minlength="2"
        class="w-full px-4 py-3 rounded-lg border border-border bg-background text-text placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
        placeholder="John"
      />
      <p class="mt-1 text-sm text-red-500 hidden" data-error="demo-firstName"></p>
    </div>
    <div>
      <label for="demo-lastName" class="block text-sm font-medium text-text mb-2">
        Last Name <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="demo-lastName"
        name="lastName"
        required
        minlength="2"
        class="w-full px-4 py-3 rounded-lg border border-border bg-background text-text placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
        placeholder="Doe"
      />
      <p class="mt-1 text-sm text-red-500 hidden" data-error="demo-lastName"></p>
    </div>
  </div>

  <div>
    <label for="demo-email" class="block text-sm font-medium text-text mb-2">
      Work Email <span class="text-red-500">*</span>
    </label>
    <input
      type="email"
      id="demo-email"
      name="email"
      required
      class="w-full px-4 py-3 rounded-lg border border-border bg-background text-text placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
      placeholder="john@company.com"
    />
    <p class="mt-1 text-sm text-red-500 hidden" data-error="demo-email"></p>
  </div>

  <div>
    <label for="demo-company" class="block text-sm font-medium text-text mb-2">
      Company <span class="text-red-500">*</span>
    </label>
    <input
      type="text"
      id="demo-company"
      name="company"
      required
      class="w-full px-4 py-3 rounded-lg border border-border bg-background text-text placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors"
      placeholder="Acme Inc"
    />
    <p class="mt-1 text-sm text-red-500 hidden" data-error="demo-company"></p>
  </div>

  <div>
    <label for="demo-teamSize" class="block text-sm font-medium text-text mb-2">
      Team Size <span class="text-red-500">*</span>
    </label>
    <div class="relative">
      <select
        id="demo-teamSize"
        name="teamSize"
        required
        class="w-full px-4 py-3 pr-10 rounded-lg border border-border bg-background text-text focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-colors appearance-none cursor-pointer"
      >
        <option value="">Select team size</option>
        <option value="1-10">1-10 developers</option>
        <option value="11-50">11-50 developers</option>
        <option value="51-200">51-200 developers</option>
        <option value="200+">200+ developers</option>
      </select>
      <div
        class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3 text-text-muted"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"
          ></path>
        </svg>
      </div>
    </div>
    <p class="mt-1 text-sm text-red-500 hidden" data-error="demo-teamSize"></p>
  </div>

  <div>
    <label for="demo-message" class="block text-sm font-medium text-text mb-2">
      What are you looking to solve? <span class="text-text-muted">(Optional)</span>
    </label>
    <textarea
      id="demo-message"
      name="message"
      rows="3"
      class="w-full px-4 py-3 rounded-lg border border-border bg-background text-text placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none transition-colors"
      placeholder="Tell us about your deployment challenges..."></textarea>
  </div>

  <!-- Form status messages -->
  <div id="demo-form-status" class="hidden">
    <div
      id="demo-form-success"
      class="hidden p-4 rounded-lg bg-green-100 dark:bg-green-950 border border-green-300 dark:border-green-800"
    >
      <p class="text-green-900 dark:text-green-100 font-medium">Demo request submitted!</p>
      <p class="text-green-800 dark:text-green-300 text-sm mt-1">
        Our team will reach out within 24 hours to schedule your demo.
      </p>
    </div>
    <div
      id="demo-form-error"
      class="hidden p-4 rounded-lg bg-red-100 dark:bg-red-950 border border-red-300 dark:border-red-800"
    >
      <p class="text-red-900 dark:text-red-100 font-medium">Something went wrong</p>
      <p class="text-red-800 dark:text-red-300 text-sm mt-1">
        Please try again or contact us directly via email.
      </p>
    </div>
  </div>

  <button
    type="submit"
    id="demo-submit-button"
    class="w-full cursor-pointer px-6 py-4 rounded-lg bg-primary text-white font-semibold hover:bg-primary-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
  >
    <span id="demo-button-text">Request Demo</span>
    <span id="demo-button-loading" class="hidden">
      <svg
        class="animate-spin inline-block w-5 h-5 mr-2"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      Submitting...
    </span>
    <svg
      id="demo-button-arrow"
      class="w-5 h-5"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
    </svg>
  </button>

  <p class="text-xs text-text-muted text-center">
    By submitting, you agree to our <a href="/privacy" class="underline hover:text-primary"
      >Privacy Policy</a
    >.
  </p>
</form>

<script>
  const form = document.getElementById('demo-request-form') as HTMLFormElement;
  const submitButton = document.getElementById('demo-submit-button') as HTMLButtonElement;
  const buttonText = document.getElementById('demo-button-text');
  const buttonLoading = document.getElementById('demo-button-loading');
  const buttonArrow = document.getElementById('demo-button-arrow');
  const formStatus = document.getElementById('demo-form-status');
  const formSuccess = document.getElementById('demo-form-success');
  const formError = document.getElementById('demo-form-error');

  // Validation rules
  const validationRules: Record<string, (value: string) => string | null> = {
    'demo-firstName': (value) => {
      if (!value.trim()) return 'First name is required';
      if (value.trim().length < 2) return 'First name must be at least 2 characters';
      return null;
    },
    'demo-lastName': (value) => {
      if (!value.trim()) return 'Last name is required';
      if (value.trim().length < 2) return 'Last name must be at least 2 characters';
      return null;
    },
    'demo-email': (value) => {
      if (!value.trim()) return 'Email is required';
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) return 'Please enter a valid email address';
      return null;
    },
    'demo-company': (value) => {
      if (!value.trim()) return 'Company name is required';
      return null;
    },
    'demo-teamSize': (value) => {
      if (!value) return 'Please select a team size';
      return null;
    },
  };

  // Show/hide error message
  function showError(fieldId: string, message: string | null) {
    const errorEl = document.querySelector(`[data-error="${fieldId}"]`);
    const inputEl = document.getElementById(fieldId);

    if (errorEl && inputEl) {
      if (message) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
        inputEl.classList.add('border-red-500');
        inputEl.classList.remove('border-border');
      } else {
        errorEl.classList.add('hidden');
        inputEl.classList.remove('border-red-500');
        inputEl.classList.add('border-border');
      }
    }
  }

  // Validate single field
  function validateField(fieldId: string): boolean {
    const input = document.getElementById(fieldId) as HTMLInputElement | HTMLSelectElement | null;
    if (!input || !validationRules[fieldId]) return true;

    const error = validationRules[fieldId](input.value);
    showError(fieldId, error);
    return !error;
  }

  // Validate all fields
  function validateForm(): boolean {
    let isValid = true;
    for (const fieldId of Object.keys(validationRules)) {
      if (!validateField(fieldId)) {
        isValid = false;
      }
    }
    return isValid;
  }

  // Real-time validation on blur
  for (const fieldId of Object.keys(validationRules)) {
    const input = document.getElementById(fieldId) as HTMLInputElement | HTMLSelectElement | null;
    if (input) {
      input.addEventListener('blur', () => validateField(fieldId));
      input.addEventListener('input', () => {
        const errorEl = document.querySelector(`[data-error="${fieldId}"]`);
        if (errorEl && !errorEl.classList.contains('hidden')) {
          validateField(fieldId);
        }
      });
    }
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Hide previous status messages
    formStatus?.classList.add('hidden');
    formSuccess?.classList.add('hidden');
    formError?.classList.add('hidden');

    // Validate form
    if (!validateForm()) {
      const firstError = form.querySelector('.border-red-500') as HTMLElement;
      firstError?.focus();
      return;
    }

    // Show loading state
    submitButton.disabled = true;
    buttonText?.classList.add('hidden');
    buttonArrow?.classList.add('hidden');
    buttonLoading?.classList.remove('hidden');

    const formData = new FormData(form);
    const action = form.action;

    try {
      // If no action URL, simulate success (demo mode)
      if (!action) {
        await new Promise((resolve) => setTimeout(resolve, 1500));
        showSuccess();
        return;
      }

      // Submit to actual endpoint
      const response = await fetch(action, {
        method: form.method || 'POST',
        body: formData,
        headers: {
          Accept: 'application/json',
        },
      });

      if (response.ok) {
        showSuccess();
      } else {
        showErrorState();
      }
    } catch {
      showErrorState();
    }
  });

  function showSuccess() {
    formStatus?.classList.remove('hidden');
    formSuccess?.classList.remove('hidden');
    form.reset();
    resetButtonState();
  }

  function showErrorState() {
    formStatus?.classList.remove('hidden');
    formError?.classList.remove('hidden');
    resetButtonState();
  }

  function resetButtonState() {
    submitButton.disabled = false;
    buttonText?.classList.remove('hidden');
    buttonArrow?.classList.remove('hidden');
    buttonLoading?.classList.add('hidden');
  }
</script>
