---
/**
 * PricingTable - Pricing plans with monthly/annual toggle
 *
 * @description
 * Displays pricing plans in a responsive grid with a billing period toggle.
 * Supports monthly/annual pricing with discount indicator, highlighting
 * a recommended plan, and customizable CTAs.
 *
 * @example Basic usage
 * ```astro
 * <PricingTable
 *   title="Simple, transparent pricing"
 *   subtitle="Start free and scale as you grow."
 *   plans={[...]}
 * />
 * ```
 *
 * @example With footer link
 * ```astro
 * <PricingTable
 *   title="Pricing"
 *   plans={[...]}
 *   footerLink={{ label: "View full pricing â†’", href: "/pricing" }}
 * />
 * ```
 */

import { Icon } from 'astro-icon/components';

/** Individual pricing plan configuration */
interface PricingPlan {
  /** Plan name (e.g., "Free", "Pro", "Enterprise") */
  name: string;
  /** Monthly price in dollars (null for custom pricing) */
  monthlyPrice: number | null;
  /** Custom price text for enterprise plans (e.g., "Custom", "Contact us") */
  customPrice?: string;
  /** Short description of the plan */
  description: string;
  /** List of features included in the plan */
  features: string[];
  /** Whether to highlight this plan as recommended */
  highlighted?: boolean;
  /** Badge text override (default: "Most Popular" for highlighted) */
  badge?: string;
  /** Call-to-action button configuration */
  cta: { label: string; href: string };
}

interface Props {
  /** Optional section heading title */
  title?: string;
  /** Optional section subtitle/description */
  subtitle?: string;
  /** Array of pricing plans to display */
  plans: PricingPlan[];
  /** Annual discount percentage (e.g., 20 for 20% off) */
  annualDiscount?: number;
  /** Default billing period */
  defaultPeriod?: 'monthly' | 'annual';
  /** Optional footer link for "View full pricing" etc. */
  footerLink?: { label: string; href: string };
  /** Section background style */
  background?: 'default' | 'muted' | 'accent';
}

const {
  title,
  subtitle,
  plans,
  annualDiscount = 20,
  defaultPeriod = 'monthly',
  footerLink,
  background = 'default',
} = Astro.props;

const hasHeading = title || subtitle;

const bgClass = {
  default: 'bg-background',
  muted: 'bg-surface',
  accent: 'bg-primary/5',
}[background];

// Calculate annual prices with discount
function getAnnualPrice(monthlyPrice: number): number {
  const yearlyTotal = monthlyPrice * 12;
  const discountedTotal = yearlyTotal * (1 - annualDiscount / 100);
  return Math.round(discountedTotal / 12);
}

function formatPrice(price: number): string {
  return price === 0 ? '$0' : `$${price}`;
}
---

<section class:list={['py-section', bgClass]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {/* Section Header */}
    {
      hasHeading && (
        <div class="text-center max-w-3xl mx-auto mb-12 opacity-0 translate-y-8 transition-all duration-1000 ease-out pricing-header">
          {title && <h2 class="text-3xl sm:text-4xl font-bold text-text">{title}</h2>}
          {subtitle && <p class="mt-4 text-lg text-text-muted">{subtitle}</p>}
        </div>
      )
    }

    <!-- Billing Toggle -->
    <div class="flex justify-center mb-12">
      <div class="inline-flex items-center gap-3 p-1.5 bg-surface border border-border rounded-lg">
        <button
          type="button"
          data-period="monthly"
          class:list={[
            'pricing-toggle-btn cursor-pointer px-4 py-2 text-sm font-medium rounded-md transition-all',
            defaultPeriod === 'monthly'
              ? 'bg-primary text-white shadow-sm'
              : 'text-text-muted hover:text-text',
          ]}
          aria-pressed={defaultPeriod === 'monthly'}
        >
          Monthly
        </button>
        <button
          type="button"
          data-period="annual"
          class:list={[
            'pricing-toggle-btn cursor-pointer px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2',
            defaultPeriod === 'annual'
              ? 'bg-primary text-white shadow-sm'
              : 'text-text-muted hover:text-text',
          ]}
          aria-pressed={defaultPeriod === 'annual'}
        >
          Annual
          {
            annualDiscount > 0 && (
              <span
                class:list={[
                  'text-xs px-1.5 py-0.5 rounded-full font-semibold',
                  defaultPeriod === 'annual'
                    ? 'bg-white/20 text-white'
                    : 'bg-primary/10 text-primary',
                ]}
              >
                -{annualDiscount}%
              </span>
            )
          }
        </button>
      </div>
    </div>

    <!-- Pricing Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="pricing-cards">
      {
        plans.map((plan, index) => {
          const hasNumericPrice = plan.monthlyPrice !== null;
          const monthlyPrice = plan.monthlyPrice ?? 0;
          const annualPrice = hasNumericPrice ? getAnnualPrice(monthlyPrice) : 0;
          const badgeText = plan.badge || (plan.highlighted ? 'Most Popular' : null);

          return (
            <div
              class:list={[
                'pricing-card relative p-8 rounded-lg border transition-all opacity-0 translate-y-12 pr-item',
                plan.highlighted
                  ? 'bg-primary/5 border-primary shadow-lg scale-[1.02]'
                  : 'bg-surface border-border hover:border-primary/50 hover:shadow-md',
              ]}
              style={`transition-duration: 800ms; transition-delay: ${index * 200}ms;`}
              data-monthly-price={hasNumericPrice ? monthlyPrice : ''}
              data-annual-price={hasNumericPrice ? annualPrice : ''}
              data-custom-price={plan.customPrice || ''}
            >
              {badgeText && (
                <div class="absolute -top-3 left-1/2 -translate-x-1/2">
                  <span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-primary rounded-full whitespace-nowrap">
                    {badgeText}
                  </span>
                </div>
              )}

              <div class="text-center">
                <h3 class="text-xl font-semibold text-text">{plan.name}</h3>
                <p class="mt-2 text-text-muted text-sm">{plan.description}</p>

                <div class="mt-6 min-h-18 flex flex-col justify-center">
                  {hasNumericPrice ? (
                    <>
                      {/* Monthly Price Display */}
                      <div
                        class:list={['price-display', defaultPeriod === 'monthly' ? '' : 'hidden']}
                        data-period="monthly"
                      >
                        <span class="text-4xl font-bold text-text">
                          {formatPrice(monthlyPrice)}
                        </span>
                        <span class="text-text-muted">/month</span>
                      </div>

                      {/* Annual Price Display */}
                      <div
                        class:list={['price-display', defaultPeriod === 'annual' ? '' : 'hidden']}
                        data-period="annual"
                      >
                        <span class="text-4xl font-bold text-text">{formatPrice(annualPrice)}</span>
                        <span class="text-text-muted">/month</span>
                        {monthlyPrice > 0 && (
                          <div class="mt-1">
                            <span class="text-xs text-text-muted line-through mr-2">
                              {formatPrice(monthlyPrice)}/mo
                            </span>
                            <span class="text-xs text-primary font-medium">
                              Save {formatPrice((monthlyPrice - annualPrice) * 12)}
                              /year
                            </span>
                          </div>
                        )}
                      </div>
                    </>
                  ) : (
                    <div class="price-display">
                      <span class="text-4xl font-bold text-text">
                        {plan.customPrice || 'Custom'}
                      </span>
                      <span class="text-text-muted">/month</span>
                    </div>
                  )}
                </div>
              </div>

              <ul class="mt-8 space-y-4">
                {plan.features.map((feature) => (
                  <li class="flex items-start gap-3">
                    <Icon name="lucide:check" class="w-5 h-5 text-primary shrink-0 mt-0.5" />
                    <span class="text-text-muted">{feature}</span>
                  </li>
                ))}
              </ul>

              <div class="mt-8">
                <a
                  href={plan.cta.href}
                  class:list={[
                    'block w-full text-center px-6 py-3 rounded-md font-medium transition-colors',
                    plan.highlighted
                      ? 'bg-primary text-white hover:bg-primary-dark'
                      : 'bg-surface border border-border text-text hover:bg-background hover:border-primary/50',
                  ]}
                >
                  {plan.cta.label}
                </a>
              </div>
            </div>
          );
        })
      }
    </div>

    {/* Footer Link */}
    {
      footerLink && (
        <div class="text-center mt-10">
          <a
            href={footerLink.href}
            class="text-primary hover:text-primary-dark font-medium transition-colors"
          >
            {footerLink.label}
          </a>
        </div>
      )
    }
  </div>
</section>

<style>
  .pricing-header.visible,
  .pr-item.visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script>
  function initPricingReveal() {
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    document.querySelectorAll('.pricing-header, .pr-item').forEach(el => observer.observe(el));
  }

  function initPricingToggle() {
    const toggleButtons = document.querySelectorAll('.pricing-toggle-btn');
    const priceDisplays = document.querySelectorAll('.price-display');
    const discountBadge = document.querySelector('.pricing-toggle-btn[data-period="annual"] span');

    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const period = button.getAttribute('data-period');

        // Update button states
        toggleButtons.forEach((btn) => {
          const isActive = btn.getAttribute('data-period') === period;
          btn.setAttribute('aria-pressed', String(isActive));

          if (isActive) {
            btn.classList.add('bg-primary', 'text-white', 'shadow-sm');
            btn.classList.remove('text-text-muted', 'hover:text-text');
          } else {
            btn.classList.remove('bg-primary', 'text-white', 'shadow-sm');
            btn.classList.add('text-text-muted', 'hover:text-text');
          }
        });

        // Update discount badge styling
        if (discountBadge) {
          if (period === 'annual') {
            discountBadge.classList.add('bg-white/20', 'text-white');
            discountBadge.classList.remove('bg-primary/10', 'text-primary');
          } else {
            discountBadge.classList.remove('bg-white/20', 'text-white');
            discountBadge.classList.add('bg-primary/10', 'text-primary');
          }
        }

        // Update price displays
        priceDisplays.forEach((display) => {
          const displayPeriod = display.getAttribute('data-period');
          if (displayPeriod) {
            display.classList.toggle('hidden', displayPeriod !== period);
          }
        });
      });
    });
  }

  // Initialize on page load
  initPricingReveal();
  initPricingToggle();

  // Re-initialize on Astro page transitions (View Transitions)
  document.addEventListener('astro:page-load', () => {
    initPricingReveal();
    initPricingToggle();
  });
</script>
