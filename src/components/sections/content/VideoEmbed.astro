---
/**
 * VideoEmbed - Video player section for demos and explainers
 *
 * @description
 * Embeds video content with support for YouTube, Vimeo, and self-hosted videos.
 * Includes optional title, description, and thumbnail with play button overlay.
 *
 * @example YouTube video
 * ```astro
 * <VideoEmbed
 *   title="See how it works"
 *   videoId="dQw4w9WgXcQ"
 *   provider="youtube"
 * />
 * ```
 *
 * @example Self-hosted video
 * ```astro
 * <VideoEmbed
 *   title="Product Demo"
 *   videoUrl="/videos/demo.mp4"
 *   thumbnail="/images/demo-thumbnail.jpg"
 * />
 * ```
 */

import { Icon } from 'astro-icon/components';

interface Props {
  /** Section title */
  title?: string;
  /** Section subtitle/description */
  subtitle?: string;
  /** Video ID for YouTube or Vimeo */
  videoId?: string;
  /** Video provider */
  provider?: 'youtube' | 'vimeo' | 'self-hosted';
  /** Direct video URL for self-hosted videos */
  videoUrl?: string;
  /** Thumbnail image URL (required for self-hosted, optional for YouTube/Vimeo) */
  thumbnail?: string;
  /** Aspect ratio */
  aspectRatio?: '16:9' | '4:3' | '1:1' | '9:16';
  /** Max width of video container */
  maxWidth?: 'sm' | 'md' | 'lg' | 'xl' | 'full';
  /** Show play button overlay (lazy load video on click) */
  lazyLoad?: boolean;
  /** Autoplay video (only works if lazyLoad is false) */
  autoplay?: boolean;
  /** Section background style */
  background?: 'default' | 'muted' | 'accent';
}

const {
  title,
  subtitle,
  videoId,
  provider = 'youtube',
  videoUrl,
  thumbnail,
  aspectRatio = '16:9',
  maxWidth = 'lg',
  lazyLoad = true,
  autoplay = false,
  background = 'default',
} = Astro.props;

const bgClass = {
  default: 'bg-background',
  muted: 'bg-surface',
  accent: 'bg-primary/5',
}[background];

const maxWidthClass = {
  sm: 'max-w-2xl',
  md: 'max-w-3xl',
  lg: 'max-w-4xl',
  xl: 'max-w-5xl',
  full: 'max-w-7xl',
}[maxWidth];

const aspectRatioClass = {
  '16:9': 'aspect-video',
  '4:3': 'aspect-[4/3]',
  '1:1': 'aspect-square',
  '9:16': 'aspect-[9/16]',
}[aspectRatio];

const hasHeading = title || subtitle;

// Generate embed URLs
const getEmbedUrl = () => {
  if (provider === 'youtube' && videoId) {
    return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
  }
  if (provider === 'vimeo' && videoId) {
    return `https://player.vimeo.com/video/${videoId}?autoplay=1`;
  }
  return videoUrl;
};

// Generate thumbnail URL
const getThumbnailUrl = () => {
  if (thumbnail) return thumbnail;
  if (provider === 'youtube' && videoId) {
    return `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
  }
  return null;
};

const embedUrl = getEmbedUrl();
const thumbnailUrl = getThumbnailUrl();
const uniqueId = `video-${Math.random().toString(36).substring(2, 11)}`;
---

<section class:list={['py-section', bgClass]}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {
      hasHeading && (
        <div class="text-center mb-10">
          {title && <h2 class="text-3xl sm:text-4xl font-bold text-text">{title}</h2>}
          {subtitle && <p class="mt-4 text-lg text-text-muted max-w-2xl mx-auto">{subtitle}</p>}
        </div>
      )
    }

    <div class:list={[maxWidthClass, 'mx-auto']}>
      <div
        class:list={[
          'relative rounded-xl overflow-hidden border border-border shadow-lg',
          aspectRatioClass,
        ]}
      >
        {
          lazyLoad && thumbnailUrl ? (
            /* Lazy load with thumbnail */
            <div
              id={uniqueId}
              class="video-container absolute inset-0 cursor-pointer group"
              data-embed-url={embedUrl}
              data-provider={provider}
              data-video-url={videoUrl}
            >
              {/* Thumbnail */}
              <img
                src={thumbnailUrl}
                alt={title || 'Video thumbnail'}
                class="absolute inset-0 w-full h-full object-cover"
                loading="lazy"
              />

              {/* Overlay */}
              <div class="absolute inset-0 bg-black/30 group-hover:bg-black/40 transition-colors" />

              {/* Play button */}
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-20 h-20 flex items-center justify-center rounded-full bg-primary text-white shadow-lg group-hover:scale-110 transition-transform">
                  <Icon name="lucide:play" class="w-8 h-8 ml-1" />
                </div>
              </div>
            </div>
          ) : provider === 'self-hosted' && videoUrl ? (
            /* Self-hosted video */
            <video
              class="absolute inset-0 w-full h-full object-cover"
              controls
              autoplay={autoplay}
              muted={autoplay}
              playsinline
              poster={thumbnailUrl}
            >
              <source src={videoUrl} type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          ) : (
            /* Direct embed */
            <iframe
              src={autoplay ? embedUrl : embedUrl?.replace('autoplay=1', 'autoplay=0')}
              class="absolute inset-0 w-full h-full"
              style="border: none;"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              loading="lazy"
            />
          )
        }
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const containers = document.querySelectorAll('.video-container');
    if (!containers.length) return;
    containers.forEach((container) => {
      container.addEventListener('click', function (this: HTMLElement) {
        const embedUrl = this.getAttribute('data-embed-url');
        const provider = this.getAttribute('data-provider');
        const videoUrl = this.getAttribute('data-video-url');

        if (provider === 'self-hosted' && videoUrl) {
          // Create video element for self-hosted
          const video = document.createElement('video');
          video.className = 'absolute inset-0 w-full h-full object-cover';
          video.controls = true;
          video.autoplay = true;
          const source = document.createElement('source');
          source.src = videoUrl;
          source.type = 'video/mp4';
          video.appendChild(source);
          this.innerHTML = '';
          this.appendChild(video);
        } else if (embedUrl) {
          // Create iframe for YouTube/Vimeo
          const iframe = document.createElement('iframe');
          iframe.src = embedUrl;
          iframe.className = 'absolute inset-0 w-full h-full';
          iframe.style.border = 'none';
          iframe.allow =
            'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          iframe.allowFullscreen = true;
          this.innerHTML = '';
          this.appendChild(iframe);
        }

        this.classList.remove('cursor-pointer');
      });
    });
  });
</script>
